<!doctype html>
<html lang="sv">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Årshjul</title>
  <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 64 64'%3E%3Ccircle cx='32' cy='32' r='30' fill='%2372a3ff'/%3E%3C/svg%3E">
  <style>
    :root{ --bg:#0b1220; --fg:#e6eefc; --muted:#9fb0d3; --card:#101a33; --border:#1e2b4f; --accent:#72a3ff; --accent2:#ffcf70; --good:#5bd6a2; --bad:#ff7a7a; }
    :root.light{ --bg:#ffffff; --fg:#0b1220; --muted:#52607a; --card:#ffffff; --border:#e5e7eb; --accent:#2b59ff; --accent2:#b45309; --good:#059669; --bad:#dc2626; }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif; background:var(--bg); color:var(--fg)}

    /* Header utan logga - justerad layout */
    header{
      position:sticky; top:0; z-index:30;
      display:grid;
      grid-template-columns: 1fr 1fr;
      align-items:center;
      gap:12px;
      padding:12px 16px;
      background:#ffffff !important;
      border-bottom:1px solid #e5e7eb;
      color:#0b1220;
    }
    
    .header-left {
      display: flex;
      align-items: center;
      gap: 16px;
    }
    
    header h1{ 
      color:#0b1220; 
      margin:0; 
      font-size:clamp(18px,2.2vw,24px);
    }
    
    /* Framträdande årsvisning */
    .year-display {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px 16px;
      background: linear-gradient(135deg, #2b59ff, #72a3ff);
      color: white;
      border-radius: 12px;
      font-weight: 600;
      font-size: 16px;
      box-shadow: 0 2px 8px rgba(43, 89, 255, 0.3);
      cursor: pointer;
      transition: all 0.2s ease;
    }
    
    .year-display:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(43, 89, 255, 0.4);
    }
    
    .year-nav-btn {
      background: rgba(255,255,255,0.2);
      border: none;
      color: white;
      width: 24px;
      height: 24px;
      border-radius: 50%;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
      font-weight: bold;
      transition: background 0.2s ease;
    }
    
    .year-nav-btn:hover {
      background: rgba(255,255,255,0.3);
    }

    .pill{display:inline-flex; align-items:center; gap:8px; font-size:12px; padding:6px 10px; border-radius:999px; border:1px solid #e5e7eb; background:#fff; color:#0b1220}

    /* Verktygsrad utan årsväljare (den är nu framträdande i headern) */
    .toolbar{
      display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-end; align-items:center;
    }
    .toolbar input,.toolbar select,.toolbar button{
      background:#fff; color:#0b1220; border:1px solid #e5e7eb; border-radius:10px; padding:8px 10px; height:36px;
    }
    .toolbar button{ cursor:pointer }
    .toolbar .group{ display:flex; gap:8px; align-items:center; }

    /* År-dropdown som bara syns i mobil-läge */
    #year, #year_m {
      display: none;
    }

    /* Filter-knapp visas bara på små skärmar */
    .btn-filter{ display:none; }
    @media (max-width:820px){
      .toolbar > :not(.btn-filter):not(.group):not(.pill){ display:none; }
      .btn-filter{ display:inline-flex; align-items:center; gap:6px; }
      
      /* På mobil: visa år-dropdown i drawern istället för nav-knappar */
      .year-nav-btn { display: none; }
      #year_m { display: block; }
    }

    /* Responsiv årsvisning */
    @media (max-width: 640px) {
      .header-left {
        flex-direction: column;
        align-items: flex-start;
        gap: 8px;
      }
      
      .year-display {
        font-size: 14px;
        padding: 6px 12px;
      }
    }

    /* Off-canvas filterpanel */
    .overlay{
      position:fixed; inset:0; background:rgba(0,0,0,.35);
      backdrop-filter:saturate(120%) blur(1px);
      display:none; z-index:40;
    }
    .overlay.show{ display:block; }
    .drawer{
      position:fixed; top:0; right:0; height:100%; width:min(92vw, 380px);
      background:#ffffff; color:#0b1220; border-left:1px solid #e5e7eb;
      box-shadow: -12px 0 30px rgba(0,0,0,.25);
      transform:translateX(100%); transition:transform .25s ease;
      z-index:50; display:flex; flex-direction:column;
    }
    .drawer.show{ transform:translateX(0); }
    .drawer header{
      position:sticky; top:0; z-index:1; background:#fff !important; color:#0b1220;
      display:flex; justify-content:space-between; align-items:center; padding:12px 14px;
      border-bottom:1px solid #e5e7eb;
    }
    .drawer .content{ padding:14px; display:flex; flex-direction:column; gap:12px; }
    .drawer input,.drawer select,.drawer button{
      background:#fff; color:#0b1220; border:1px solid #e5e7eb; border-radius:10px; padding:10px 12px; height:auto;
    }
    .drawer .row{ display:flex; gap:8px; align-items:center; }
    .drawer .actions{ margin-top:auto; padding:14px; border-top:1px solid #e5e7eb; display:flex; gap:8px; }

    /* Innehåll */
    .wrap{display:grid; grid-template-columns:1fr 1fr; gap:18px; padding:18px; height:calc(100vh - 70px); align-items:stretch}
    @media (max-width:980px){ .wrap{grid-template-columns:1fr; height:auto} }

    /* Tidslinje-läge: 1 kolumn, två rader (50/50) */
    body[data-view="timeline"] .wrap{
      grid-template-columns:1fr;
      grid-template-rows: 1fr 1fr;
      height:calc(100vh - 70px);
    }

    .card{background:var(--card); border:1px solid var(--border); border-radius:14px; padding:14px; display:flex; flex-direction:column; min-height:0}
    .stage,.timeline-stage{display:grid; place-items:center; flex:1 1 auto; min-height:0}
    svg{max-width:100%; height:auto}

    .legend{display:flex; gap:8px; flex-wrap:wrap; margin-top:10px}
    .legend .chip{
      display:inline-flex; align-items:center; gap:6px; padding:6px 10px;
      border:1px solid var(--border); border-radius:999px; background:var(--card); font-size:12px;
    }
    .legend .dot{width:10px; height:10px; border-radius:999px}

    .list{display:flex; flex-direction:column; gap:10px; overflow:auto; flex:1 1 auto; min-height:0}
    .item{background:color-mix(in hsl, var(--card) 80%, black 5%); border:1px solid var(--border); border-radius:12px; padding:10px}
    .item h3{margin:0 0 6px; font-size:15px}
    .item small{color:var(--muted)}
    a{color:var(--accent)}
    .error{background:#2a0f14; border:1px solid #5a1b25; color:#ffd2d2; padding:10px; border-radius:10px; margin-top:10px; display:none}

    #tooltip{position:fixed; pointer-events:none; z-index:60; background:var(--card); color:var(--fg); border:1px solid var(--border); border-radius:10px; padding:8px 10px; font-size:12px; box-shadow:0 6px 20px rgba(0,0,0,.25); display:none; max-width:260px}

    /* Visa/dölj kort beroende på läge */
    #wheelCard,#listCard{ display:flex; }
    #timelineCard,#stickyCard{ display:none; }
    body[data-view="timeline"] #wheelCard,
    body[data-view="timeline"] #listCard{ display:none; }
    body[data-view="timeline"] #timelineCard,
    body[data-view="timeline"] #stickyCard{ display:flex; }

    /* Lappar */
    .board{ flex:1 1 auto; min-height:0; overflow:auto; }
    .notes{
      display:grid;
      grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
      gap:12px;
      align-content:start;
    }
    .note{
      background:linear-gradient(180deg, color-mix(in hsl, var(--accent2) 25%, transparent 75%), color-mix(in hsl, var(--card) 85%, black 5%));
      color:var(--fg);
      border:1px solid var(--border);
      border-radius:12px;
      padding:12px;
      box-shadow:0 10px 18px rgba(0,0,0,.18);
      transform:rotate(var(--rot, 0deg));
    }
    .note h4{ margin:0 0 6px; font-size:15px }
    .note small{ color:var(--muted) }
    .note .cat{ display:inline-block; margin-top:6px; font-size:11px; padding:4px 8px; border-radius:999px; border:1px solid var(--border); background:color-mix(in hsl, var(--card) 80%, black 5%); }
  </style>
</head>
<body>
  <header>
    <div class="header-left">
      <h1>Årshjul - ULF</h1>
      
      <!-- Framträdande årsvisning med navigation -->
      <div class="year-display" onclick="showYearOptions()">
        <button class="year-nav-btn" onclick="event.stopPropagation(); changeYear(-1)" title="Föregående år">‹</button>
        <span id="currentYearDisplay">2024</span>
        <button class="year-nav-btn" onclick="event.stopPropagation(); changeYear(1)" title="Nästa år">›</button>
      </div>
      
      <span class="pill">Tidzon: Europe/Stockholm</span>
    </div>

    <!-- Filtrering + vy + tema (utan årsväljare) -->
    <div class="toolbar">
      <input id="search" placeholder="Sök titel/beskrivning…" />
      <select id="category"><option value="">Alla kategorier</option></select>
      <select id="year" style="display:none;"></select>
      <button id="refresh">Uppdatera</button>

      <div class="group pill" style="gap:8px">
        Vy:
        <select id="viewMode" style="border:0; background:transparent; height:auto; padding:0">
          <option value="wheel">Hjul + lista</option>
          <option value="timeline">Tidslinje + lappar</option>
        </select>
      </div>

      <label class="pill" style="gap:6px; cursor:pointer">
        <input id="themeSwitch" type="checkbox" />
        <span id="themeLabel">Mörkt läge</span>
      </label>

      <!-- Mobil: öppna filterpanel -->
      <button class="pill btn-filter" id="openFilter">Filter</button>
    </div>
  </header>

  <!-- Off-canvas filterpanel (mobil) -->
  <div class="overlay" id="overlay"></div>
  <aside class="drawer" id="drawer" aria-hidden="true" aria-label="Filterpanel">
    <header>
      <strong>Filter</strong>
      <button class="pill" id="closeFilter">Stäng</button>
    </header>
    <div class="content">
      <label>Sök</label>
      <input id="search_m" placeholder="Sök titel/beskrivning…"/>

      <label>Kategori</label>
      <select id="category_m"><option value="">Alla kategorier</option></select>

      <label>År</label>
      <select id="year_m"></select>

      <div class="row">
        <button id="refresh_m">Uppdatera</button>
        <label class="pill" style="gap:6px; cursor:pointer">
          <input id="themeSwitch_m" type="checkbox" />
          <span id="themeLabel_m">Mörkt läge</span>
        </label>
      </div>

      <div class="row" style="gap:10px">
        <span>Vy:</span>
        <select id="viewMode_m">
          <option value="wheel">Hjul + lista</option>
          <option value="timeline">Tidslinje + lappar</option>
        </select>
      </div>
    </div>
    <div class="actions">
      <button class="pill" id="applyFilter">Tillämpa</button>
      <button class="pill" id="cancelFilter">Avbryt</button>
    </div>
  </aside>

  <div id="tooltip" aria-hidden="true"></div>

  <div class="wrap">
    <!-- ===== HJUL + LISTA ===== -->
    <section class="card" id="wheelCard">
      <div class="stage" id="stage"></div>
      <div class="legend" id="legend"></div>
      <div class="error" id="err"></div>
    </section>

    <section class="card" id="listCard">
      <h2 style="margin:0 0 10px">Händelser</h2>
      <div class="list" id="list"></div>
    </section>

    <!-- ===== TIDSLINJE + LAPPAR ===== -->
    <section class="card" id="timelineCard">
      <div class="timeline-stage" id="timelineStage"></div>
      <div class="legend" id="legend_tl"></div>
      <div class="error" id="err_tl"></div>
    </section>

    <section class="card" id="stickyCard">
      <h2 style="margin:0 0 10px">Lappar</h2>
      <div class="board">
        <div class="notes" id="notes"></div>
      </div>
    </section>
  </div>

<script>
/* ====== KONFIG ====== */
const DEFAULT_API_BASE='https://script.google.com/macros/s/AKfycbzCW_W-5BjBxVK9YlcFTSVxpqr0KaH1uwm-wGB_lxGY8MUaoSWOnaiUHQNQZ7tmQ8rN/exec?sheet=ulf';
const API_BASE=localStorage.getItem('apiUrl')||DEFAULT_API_BASE;

/* ====== Hjälpare ====== */
const el=s=>document.querySelector(s);
const MONTHS=['Jan','Feb','Mar','Apr','Maj','Jun','Jul','Aug','Sep','Okt','Nov','Dec'];

let ALL_EVENTS=[],VIEW_EVENTS=[],CATEGORY_COLORS={},CATEGORY_LANES={};
let CURRENT_YEAR = new Date().getFullYear();

function hashStr(s){let h=0;for(let i=0;i<s.length;i++){h=((h<<5)-h)+s.charCodeAt(i);h|=0;}return Math.abs(h);}
function colorForCategory(cat){if(!cat)return 'var(--accent)';if(CATEGORY_COLORS[cat])return CATEGORY_COLORS[cat];const h=hashStr(cat)%360;const clr=`hsl(${h} 70% 55%)`;CATEGORY_COLORS[cat]=clr;return clr;}
function showError(target,msg){const b=el(target);b.textContent=msg;b.style.display='block';}
function clearError(target){const b=el(target);b.textContent='';b.style.display='none';}

/* ====== Årsnavigation ====== */
function updateYearDisplay() {
  el('#currentYearDisplay').textContent = CURRENT_YEAR;
  el('#year').value = CURRENT_YEAR;
  el('#year_m').value = CURRENT_YEAR;
}

function changeYear(delta) {
  CURRENT_YEAR += delta;
  updateYearDisplay();
  recomputeView();
  syncToMobile();
}

function showYearOptions() {
  // På desktop: visa inte något speciellt (bara använd pilknapparna)
  // På mobil kommer år-dropdownen att vara synlig i drawern
}

/* ====== Tema ====== */
function setTheme(isLight){
  const root=document.documentElement;
  root.classList.toggle('light',isLight);
  el('#themeSwitch').checked=isLight;
  el('#themeLabel').textContent=isLight?'Ljust läge':'Mörkt läge';
  el('#themeSwitch_m').checked=isLight;
  el('#themeLabel_m').textContent=isLight?'Ljust läge':'Mörkt läge';
  localStorage.setItem('theme2',isLight?'light':'dark');
}
function initTheme(){
  const saved=localStorage.getItem('theme2')||'dark';
  setTheme(saved==='light');
  el('#themeSwitch').onchange=()=>setTheme(el('#themeSwitch').checked);
  el('#themeSwitch_m').onchange=()=>setTheme(el('#themeSwitch_m').checked);
}

/* ====== Datum ====== */
function dayOfYear(d){const s=new Date(Date.UTC(d.getUTCFullYear(),0,1));return Math.floor((d-s)/86400000)+1;}
function angleFor(d){const y=d.getUTCFullYear();const s=new Date(Date.UTC(y,0,1));const e=new Date(Date.UTC(y+1,0,1));const total=(e-s)/86400000;const frac=dayOfYear(d)/total;return frac*Math.PI*2 - Math.PI/2;}
function fracOfYear(d){const y=d.getUTCFullYear();const s=new Date(Date.UTC(y,0,1));const e=new Date(Date.UTC(y+1,0,1));const total=(e-s);return (d-s)/total;}
function yearWindow(y){return{start:new Date(Date.UTC(y,0,1)),end:new Date(Date.UTC(y,11,31,23,59,59))};}
function normalizeRange(s,e){ if(!e) return {s,e:s}; let s2=new Date(s), e2=new Date(e); while(e2<=s2){ e2.setUTCFullYear(e2.getUTCFullYear()+1); } return {s:s2,e:e2}; }

/* ====== Hämta data ====== */
async function fetchEvents(){
  const base=localStorage.getItem('apiUrl')||API_BASE;
  const res=await fetch(base,{headers:{'Accept':'application/json'}});
  if(!res.ok) throw new Error('API fel ('+res.status+')');
  const txt=await res.text(); try{return JSON.parse(txt);}catch{throw new Error('API-svar var inte JSON');}
}

/* ====== Årsfilter + lanes ====== */
function filterForYear(all,y){
  const {start,end}=yearWindow(y);
  const arr=all.map(ev=>{
    const sRaw=new Date(ev.start_date+'T12:00:00Z');
    const eRaw=ev.end_date?new Date(ev.end_date+'T23:59:59Z'):null;
    const {s,e}=normalizeRange(sRaw,eRaw||sRaw);
    if(e<start || s>end) return null;
    const segStart=new Date(Math.max(s,start));
    const segEnd=new Date(Math.min(e,end));
    return {...ev,_segStart:segStart,_segEnd:segEnd};
  }).filter(Boolean);

  const cats=[...new Set(arr.map(e=>e.category||'Okategoriserat'))].sort();
  CATEGORY_LANES=Object.fromEntries(cats.map((c,i)=>[c,i]));
  return arr;
}

/* ====== Legend (passiv) ====== */
function buildLegend(events, targetId){
  const wrap=el(targetId); wrap.innerHTML='';
  const cats=new Map();
  events.forEach(e=>{
    const k=e.category||'Okategoriserat';
    const col=e.color||colorForCategory(e.category);
    if(!cats.has(k)) cats.set(k,col);
  });
  for(const [cat,col] of cats.entries()){
    const chip=document.createElement('span'); chip.className='chip';
    chip.innerHTML=`<span class="dot" style="background:${col}"></span>${cat}`;
    wrap.appendChild(chip);
  }
}

/* ====== Hjul ====== */
function drawWheel(events){
  const stage=el('#stage'); stage.innerHTML='';
  const svg=document.createElementNS('http://www.w3.org/2000/svg','svg');
  svg.setAttribute('viewBox','-240 -240 480 480');

  const R=200, BASE_ARC=190;

  const ring=document.createElementNS(svg.namespaceURI,'circle');
  ring.setAttribute('r',R); ring.setAttribute('fill','none');
  ring.setAttribute('stroke','var(--border)'); ring.setAttribute('stroke-width','2');
  svg.appendChild(ring);

  for(let m=0;m<12;m++){
    const a=(m/12)*Math.PI*2 - Math.PI/2;
    const x1=Math.cos(a)*(R-20), y1=Math.sin(a)*(R-20);
    const x2=Math.cos(a)*R,      y2=Math.sin(a)*R;
    const line=document.createElementNS(svg.namespaceURI,'line');
    line.setAttribute('x1',x1); line.setAttribute('y1',y1);
    line.setAttribute('x2',x2); line.setAttribute('y2',y2);
    line.setAttribute('stroke','var(--border)');
    svg.appendChild(line);

    const lbl=document.createElementNS(svg.namespaceURI,'text');
    lbl.setAttribute('x',Math.cos(a)*(R-45));
    lbl.setAttribute('y',Math.sin(a)*(R-45));
    lbl.setAttribute('text-anchor','middle');
    lbl.setAttribute('fill','var(--muted)');
    lbl.textContent=MONTHS[m];
    svg.appendChild(lbl);
  }

  const tip=el('#tooltip');
  function showTip(evt,html){tip.innerHTML=html;tip.style.display='block';const pad=12;tip.style.left=(evt.clientX+pad)+'px';tip.style.top=(evt.clientY+pad)+'px';}
  function hideTip(){tip.style.display='none';}

  function arcBetween(s,e,r,color,tipHtml,id){
    if(e.getTime()===s.getTime()){
      const a=angleFor(s);
      const dot=document.createElementNS(svg.namespaceURI,'circle');
      dot.setAttribute('cx',Math.cos(a)*r);
      dot.setAttribute('cy',Math.sin(a)*r);
      dot.setAttribute('r',6);
      dot.setAttribute('fill',color);
      dot.addEventListener('mouseenter',ev=>showTip(ev,tipHtml));
      dot.addEventListener('mousemove',ev=>showTip(ev,tipHtml));
      dot.addEventListener('mouseleave',hideTip);
      dot.style.cursor='pointer';
      dot.addEventListener('click',()=>{ const t=document.getElementById('item-'+(id||'')); if(t) t.scrollIntoView({behavior:'smooth',block:'center'}); });
      svg.appendChild(dot);
      return;
    }
    const a1=angleFor(s), a2=angleFor(e);
    const delta=(a2-a1+Math.PI*2)%(Math.PI*2);
    const largeArc=delta>Math.PI?1:0;
    const x1=Math.cos(a1)*r, y1=Math.sin(a1)*r;
    const x2=Math.cos(a2)*r, y2=Math.sin(a2)*r;
    const path=document.createElementNS(svg.namespaceURI,'path');
    path.setAttribute('d',`M ${x1} ${y1} A ${r} ${r} 0 ${largeArc} 1 ${x2} ${y2}`);
    path.setAttribute('stroke',color); path.setAttribute('fill','none');
    path.setAttribute('stroke-width','6'); path.setAttribute('stroke-linecap','round'); path.setAttribute('opacity','0.9');
    path.addEventListener('mouseenter',ev=>showTip(ev,tipHtml));
    path.addEventListener('mousemove',ev=>showTip(ev,tipHtml));
    path.addEventListener('mouseleave',hideTip);
    path.style.cursor='pointer';
    path.addEventListener('click',()=>{ const t=document.getElementById('item-'+(id||'')); if(t) t.scrollIntoView({behavior:'smooth',block:'center'}); });
    svg.appendChild(path);
  }

  events.forEach(ev=>{
    const lane=CATEGORY_LANES[ev.category||'Okategoriserat']||0;
    const r=BASE_ARC - lane*10;
    const col=ev.color||colorForCategory(ev.category);
    const s=ev._segStart, e=ev._segEnd;
    const tipHtml=`<strong>${ev.title||''}</strong><br>${ev.start_date}${ev.end_date?` – ${ev.end_date}`:''}${ev.category?` • ${ev.category}`:''}`;
    arcBetween(s,e,r,col,tipHtml,ev.id);
  });

  stage.appendChild(svg);
}

/* ====== Tidslinje ====== */
function drawTimeline(events){
  const stage=el('#timelineStage'); stage.innerHTML='';
  const svg=document.createElementNS('http://www.w3.org/2000/svg','svg');
  svg.setAttribute('viewBox','0 0 1200 430');
  svg.setAttribute('preserveAspectRatio','xMidYMid meet');

  const W=1200, H=430;
  const topPad=48, leftPad=90, rightPad=24, bottomPad=58;
  const lanes=Object.keys(CATEGORY_LANES).length || 1;
  const laneH=(H-topPad-bottomPad)/lanes;
  const barH=Math.max(8, laneH*0.36);

  for(let m=0;m<=12;m++){
    const x=leftPad + ( (W-leftPad-rightPad) * (m/12) );
    const line=document.createElementNS(svg.namespaceURI,'line');
    line.setAttribute('x1',x); line.setAttribute('y1',topPad-10);
    line.setAttribute('x2',x); line.setAttribute('y2',H-bottomPad);
    line.setAttribute('stroke','var(--border)');
    svg.appendChild(line);

    if(m<12){
      const labelTop=document.createElementNS(svg.namespaceURI,'text');
      labelTop.setAttribute('x', leftPad + ( (W-leftPad-rightPad) * ((m+0.5)/12) ));
      labelTop.setAttribute('y', topPad-18);
      labelTop.setAttribute('text-anchor','middle');
      labelTop.setAttribute('fill','var(--muted)');
      labelTop.textContent=MONTHS[m];
      svg.appendChild(labelTop);

      const labelBot=document.createElementNS(svg.namespaceURI,'text');
      labelBot.setAttribute('x', leftPad + ( (W-leftPad-rightPad) * ((m+0.5)/12) ));
      labelBot.setAttribute('y', H-bottomPad+24);
      labelBot.setAttribute('text-anchor','middle');
      labelBot.setAttribute('fill','var(--muted)');
      labelBot.textContent=MONTHS[m];
      svg.appendChild(labelBot);
    }
  }

  Object.entries(CATEGORY_LANES).forEach(([cat,idx])=>{
    const y = topPad + idx*laneH + laneH/2 + 4;
    const t=document.createElementNS(svg.namespaceURI,'text');
    t.setAttribute('x', 10);
    t.setAttribute('y', y+4);
    t.setAttribute('fill','var(--muted)');
    t.textContent=cat;
    svg.appendChild(t);

    const base=document.createElementNS(svg.namespaceURI,'line');
    base.setAttribute('x1',leftPad); base.setAttribute('y1',y);
    base.setAttribute('x2',W-rightPad); base.setAttribute('y2',y);
    base.setAttribute('stroke','var(--border)');
    base.setAttribute('stroke-dasharray','3 4');
    svg.appendChild(base);
  });

  const tip=el('#tooltip');
  function showTip(evt,html){tip.innerHTML=html;tip.style.display='block';const pad=12;tip.style.left=(evt.clientX+pad)+'px';tip.style.top=(evt.clientY+pad)+'px';}
  function hideTip(){tip.style.display='none';}

  const yForLane = (cat)=>{
    const idx=CATEGORY_LANES[cat||'Okategoriserat']||0;
    return topPad + idx*laneH + laneH/2 - barH/2;
  };
  const xFor = (d) => leftPad + (W-leftPad-rightPad)*fracOfYear(d);

  events.forEach(ev=>{
    const y=yForLane(ev.category);
    const col=ev.color||colorForCategory(ev.category);
    const s=ev._segStart, e=ev._segEnd;

    const tipHtml=`<strong>${ev.title||''}</strong><br>${ev.start_date}${ev.end_date?` – ${ev.end_date}`:''}${ev.category?` • ${ev.category}`:''}`;

    if(e.getTime()===s.getTime()){
      const cx=xFor(s), cy=y+barH/2;
      const c=document.createElementNS(svg.namespaceURI,'circle');
      c.setAttribute('cx',cx); c.setAttribute('cy',cy); c.setAttribute('r',6);
      c.setAttribute('fill',col);
      c.style.cursor='pointer';
      c.addEventListener('mouseenter',evm=>showTip(evm,tipHtml));
      c.addEventListener('mousemove',evm=>showTip(evm,tipHtml));
      c.addEventListener('mouseleave',hideTip);
      c.addEventListener('click',()=>{ const t=document.getElementById('note-'+(ev.id||'')); if(t) t.scrollIntoView({behavior:'smooth',block:'center'}); });
      svg.appendChild(c);
    }else{
      const x1=xFor(s), x2=xFor(e);
      const r = Math.min(8, barH/2);
      const rect=document.createElementNS(svg.namespaceURI,'rect');
      rect.setAttribute('x',Math.min(x1,x2));
      rect.setAttribute('y',y);
      rect.setAttribute('width',Math.max(2,Math.abs(x2-x1)));
      rect.setAttribute('height',barH);
      rect.setAttribute('rx',r); rect.setAttribute('ry',r);
      rect.setAttribute('fill',col);
      rect.setAttribute('opacity','0.9');
      rect.style.cursor='pointer';
      rect.addEventListener('mouseenter',evm=>showTip(evm,tipHtml));
      rect.addEventListener('mousemove',evm=>showTip(evm,tipHtml));
      rect.addEventListener('mouseleave',hideTip);
      rect.addEventListener('click',()=>{ const t=document.getElementById('note-'+(ev.id||'')); if(t) t.scrollIntoView({behavior:'smooth',block:'center'}); });
      svg.appendChild(rect);
    }
  });

  stage.appendChild(svg);
}

/* ====== Filtrering ====== */
function getFiltered(base){
  const q=el('#search').value.toLowerCase();
  const c=el('#category').value;
  return base.filter(ev=>{
    const hay=`${ev.title} ${ev.description||''} ${ev.category||''}`.toLowerCase();
    return (!q||hay.includes(q)) && (!c||ev.category===c);
  });
}

/* ====== Listan (hjul-läget) ====== */
function renderList(events){
  const list=el('#list'); list.innerHTML='';
  const filtered=getFiltered(events).sort((a,b)=>a.start_date.localeCompare(b.start_date));
  filtered.forEach(ev=>{
    const col=ev.color||colorForCategory(ev.category);
    const div=document.createElement('div'); div.className='item'; div.id='item-'+(ev.id||'');
    div.innerHTML=`<h3><span style="display:inline-block;width:10px;height:10px;background:${col};border-radius:999px;margin-right:8px"></span>${ev.title}</h3>
    <small>${ev.start_date}${ev.end_date?` – ${ev.end_date}`:''}${ev.category?` • ${ev.category}`:''}${ev.location?` • ${ev.location}`:''}</small>
    <div class="sp"></div><p style="margin:0 0 8px">${ev.description||''}</p>${ev.link?`<a href="${ev.link}" target="_blank" rel="noreferrer">Öppna länk</a>`:''}`;
    list.appendChild(div);
  });
  
  const catSel=el('#category'); const current=catSel.value;
  const cats=[...new Set(events.map(e=>e.category).filter(Boolean))].sort();
  catSel.innerHTML='<option value="">Alla kategorier</option>'+cats.map(c=>`<option value="${c}">${c}</option>`).join('');
  if([...catSel.options].some(o=>o.value===current)) catSel.value=current;

  syncToMobile();
}

/* ====== Lappar (tidslinje-läget) ====== */
function renderNotes(events){
  const notes=el('#notes'); notes.innerHTML='';
  const filtered=getFiltered(events).sort((a,b)=>a.start_date.localeCompare(b.start_date));

  filtered.forEach((ev,i)=>{
    const col=ev.color||colorForCategory(ev.category);
    const d=document.createElement('div');
    d.className='note';
    d.id='note-'+(ev.id||'');
    d.style.setProperty('--rot', (i%7-3)*0.4 + 'deg');
    d.innerHTML=`
      <h4>${ev.title||''}</h4>
      <small>${ev.start_date}${ev.end_date?` – ${ev.end_date}`:''}</small>
      ${ev.category?`<div class="cat" style="margin-top:8px"><span style="display:inline-block;width:8px;height:8px;background:${col};border-radius:999px;margin-right:6px"></span>${ev.category}</div>`:''}
      ${ev.location?`<div style="margin-top:6px"><small>${ev.location}</small></div>`:''}
      ${ev.description?`<p style="margin:8px 0 0">${ev.description}</p>`:''}
      ${ev.link?`<div style="margin-top:8px"><a href="${ev.link}" target="_blank" rel="noreferrer">Öppna länk</a></div>`:''}
    `;
    notes.appendChild(d);
  });

  const catSel=el('#category'); const current=catSel.value;
  const cats=[...new Set(events.map(e=>e.category).filter(Boolean))].sort();
  catSel.innerHTML='<option value="">Alla kategorier</option>'+cats.map(c=>`<option value="${c}">${c}</option>`).join('');
  if([...catSel.options].some(o=>o.value===current)) catSel.value=current;

  syncToMobile();
}

/* ====== Vy-uppdatering ====== */
function updateFilteredUI(){
  const view=document.body.getAttribute('data-view')||'wheel';
  const filtered=getFiltered(VIEW_EVENTS);

  if(view==='wheel'){
    buildLegend(filtered, '#legend');
    drawWheel(filtered);
    renderList(VIEW_EVENTS);
  }else{
    buildLegend(filtered, '#legend_tl');
    drawTimeline(filtered);
    renderNotes(VIEW_EVENTS);
  }
}

/* ====== Off-canvas: spegling utan logikändring ====== */
function syncToMobile(){
  el('#search_m').value = el('#search').value;
  const catSel = el('#category'), catMob = el('#category_m');
  catMob.innerHTML = catSel.innerHTML; catMob.value = catSel.value;
  const yrSel = el('#year'), yrMob = el('#year_m');
  yrMob.innerHTML = yrSel.innerHTML; yrMob.value = yrSel.value;
  el('#viewMode_m').value = el('#viewMode').value;
}

function applyMobileToMain(){
  el('#search').value = el('#search_m').value;
  el('#category').value = el('#category_m').value;
  
  // Hantera årsändring från mobil
  if(el('#year_m').value && el('#year_m').value !== String(CURRENT_YEAR)){
    CURRENT_YEAR = parseInt(el('#year_m').value, 10);
    updateYearDisplay();
    recomputeView();
  }else{
    updateFilteredUI();
  }
  
  document.body.setAttribute('data-view', el('#viewMode_m').value);
  el('#viewMode').value = el('#viewMode_m').value;
  localStorage.setItem('viewMode', el('#viewMode').value);
}

/* ====== Init/Load ====== */
async function loadAll(){
  try{
    clearError('#err'); clearError('#err_tl');
    ALL_EVENTS=await fetchEvents();
    recomputeView();
  }catch(e){
    showError('#err', e.message);
    showError('#err_tl', e.message);
    console.error(e);
  }
}

function recomputeView(){
  try{
    clearError('#err'); clearError('#err_tl');
    CATEGORY_COLORS={};
    VIEW_EVENTS=filterForYear(ALL_EVENTS, CURRENT_YEAR);
    updateFilteredUI();
  }catch(e){
    showError('#err', e.message);
    showError('#err_tl', e.message);
    console.error(e);
  }
}

function populateYears(){
  const sel=el('#year');
  const selM=el('#year_m');
  const currentYear = new Date().getFullYear();
  const ys=[currentYear-1,currentYear,currentYear+1,currentYear+2];
  const options = ys.map(v=>`<option ${v===currentYear?'selected':''} value="${v}">${v}</option>`).join('');
  sel.innerHTML = options;
  selM.innerHTML = options;
  
  CURRENT_YEAR = currentYear;
  updateYearDisplay();
}

/* ====== Start ====== */
window.addEventListener('DOMContentLoaded',()=>{
  initTheme();
  populateYears();

  const savedView=localStorage.getItem('viewMode')||'wheel';
  document.body.setAttribute('data-view', savedView);
  el('#viewMode').value = savedView;

  el('#refresh').onclick=()=>loadAll();
  el('#category').onchange=()=>{ updateFilteredUI(); syncToMobile(); };
  el('#search').oninput =()=>{ updateFilteredUI(); syncToMobile(); };
  
  // Årsändring via hidden dropdown (för kompatibilitet)
  el('#year').onchange=()=>{ 
    CURRENT_YEAR = parseInt(el('#year').value, 10);
    updateYearDisplay();
    recomputeView(); 
    syncToMobile(); 
  };

  el('#viewMode').onchange=(e)=>{
    const mode=e.target.value;
    document.body.setAttribute('data-view', mode);
    localStorage.setItem('viewMode', mode);
    updateFilteredUI();
    syncToMobile();
  };

  const drawer=el('#drawer'), overlay=el('#overlay');
  function openDrawer(){ drawer.classList.add('show'); overlay.classList.add('show'); drawer.setAttribute('aria-hidden','false'); syncToMobile(); }
  function closeDrawer(){ drawer.classList.remove('show'); overlay.classList.remove('show'); drawer.setAttribute('aria-hidden','true'); }

  el('#openFilter').onclick = openDrawer;
  el('#closeFilter').onclick = closeDrawer;
  el('#cancelFilter').onclick = closeDrawer;
  overlay.onclick = closeDrawer;

  el('#applyFilter').onclick = ()=>{ applyMobileToMain(); closeDrawer(); };
  el('#refresh_m').onclick = ()=>{ applyMobileToMain(); };

  loadAll();
});

// Globala funktioner för årsnavigation
window.changeYear = changeYear;
window.showYearOptions = showYearOptions;
</script>
</body>
</html>
